<!--
(C) Copyright 2016 Nuxeo SA (http://nuxeo.com/) and others.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Contributors:
  Andre Justo <ajusto@nuxeo.com>
  Nelson Silva <nsilva@nuxeo.com>
  Gabriel Barata <gbarata@nuxeo.com>
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/nuxeo-ui-elements/nuxeo-routing-behavior.html">
<link rel="import" href="../../bower_components/nuxeo-ui-elements/nuxeo-i18n-behavior.html">

<!--
`nuxeo-app`
@group Nuxeo UI
@element nuxeo-app
-->
<dom-module id="nuxeo-app">
  <template>
    <style is="custom-style" include="shared-styles">
      .logo {
        background: #fafcfd;
        border-right: var(--nuxeo-border);
        height: 59px;
        padding: 18px;
        position: fixed;
        top: 0;
        left: 0;
        width: 60px;
        z-index: 150;
      }

      paper-badge {
        --paper-badge-background: var(--nuxeo-badge-background);
      }

      iron-collapse {
        overflow: scroll;
      }

      ::content --paper-icon-button-hover {
        filter: brightness(102%);
        webkit-filter: brightness(102%);
      }

      #sidebar > div {
        margin-left: 60px;
      }

      #sidebar section {
        border-right: var(--nuxeo-border);
      }

      #sidebar .content {
        font-size: .9rem;
        @apply(--layout-flex);
        @apply(--layout-vertical);
        overflow: auto;
        width: 290px;
        height: calc(100vh - 59px);
      }

      #sidebar .card .header {
        height: 59px;
        background-color: var(--nuxeo-light-background);
        border-bottom: var(--nuxeo-border);
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      #sidebar .card h1 {
        color: var(--nuxeo-tag-text);
        text-transform: uppercase;
        font-size: 1rem;
        margin: .1em .2em 0 1.1em;
        font-weight: 500;
      }

      #sidebar .item {
        border-bottom: var(--nuxeo-border);
        display: block;
        padding: 1em;
      }

      #sidebar .item a {
        margin-bottom: 0;
      }

      #sidebar .tasks .link {
        font-size: 1.2em;
        padding: 1em 1em 2em 1em;
        text-align: center;
      }

      #sidebar .profile .item:last-of-type {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        border: none;
        justify-content: flex-end;
      }

      .icon-badge {
        position: relative;
      }

      .header-badge {
        left: 33px !important;
        top: 6px !important;
        position: absolute;
      }

      [hidden] {
        display: none !important;
      }

      nuxeo-task-widget {
        --nuxeo-task-widget-box-padding: 1em 1em 1em .7em;
        font-size: .9em;
      }

      nuxeo-tasks-list {
        font-size: .9em;
      }

      .side-nav {
        padding: 60px 0;
        overflow: auto;
      }

      .side-nav paper-icon-button {
        color: #00adff;
        height: 50px;
        padding: 14px;
        width: 60px;
      }

      .side-nav paper-icon-button.iron-selected {
        color: #fff;

      }

      .side-nav paper-icon-button.iron-selected,
      .side-nav paper-icon-button:hover {
        background-color: rgba(255,255,255,.03);
      }

      .side-nav .profile-icon {
        bottom: 0;
        position: fixed;
        left: 0;
        height: 59px;
      }

      nuxeo-search-results .actions paper-button {
        font-size: .8em;
        font-weight: normal;
        margin: 0;
        text-transform: none;
      }

      nuxeo-search-results .actions paper-button[disabled] {
        background: none;
      }

      paper-card {
        margin: 0 22px 22px 0;
        min-width: 560px;
        width: 100%;
        height: 100%;
      }

      paper-card .title {
        color: var(--nuxeo-title-color);
        font-size: 1.4rem;
        margin: 0 0 .4em;
        padding-bottom: 8px;
        border-bottom: var(--nuxeo-border);
      }

      .experimental {
        position: absolute;
        color: var(--nuxeo-button-primary);
        right: 5px;
        bottom: 5px;
        font-size: .7em;
      }
    </style>

    <nuxeo-connection id="nxcon"></nuxeo-connection>

    <nuxeo-document id="doc" auto doc-path="[[docPath]]"
                    response="{{currentDocument}}"
                    enrichers="permissions, breadcrumb, preview, favorites, renditions, pendingTasks, runnableWorkflows, runningWorkflows, collections, audit"
                    headers='{"X-NXfetch.document": "lock"}'>
    </nuxeo-document>
    <nuxeo-document id="idResolver"
                    doc-id="[[linkDocId]]"
                    response="{{resolvedDocument}}">
    </nuxeo-document>
    <nuxeo-resource id="tasks" path="/task"
                    headers='{"X-NXfetch.task": "targetDocumentIds,actors"}'>
    </nuxeo-resource>

    <nuxeo-document id="searchDoc" auto
                    doc-id="[[selectedSearch.id]]"
                    enrichers="permissions"
                    response="{{searchDoc}}">
    </nuxeo-document>

    <paper-toast id="toast"></paper-toast>

    <paper-drawer-panel drawer-width="[[drawerWidth]]" responsive-width="720px">
      <div drawer>
        <a href$="[[urlFor('home')]]">
          <paper-icon-button src$="[[baseUrl]]images/touch/icon-128x128.png" class="logo"></paper-icon-button>
        </a>
        <paper-menu class="side-nav" selected="{{selectedTab}}" attr-for-selected="name" on-iron-activate="_toggleDrawer">
          <paper-icon-button icon="icons:folder-open" name="browser"></paper-icon-button>
          <paper-icon-button icon="icons:restore" name="recents"></paper-icon-button>
          <paper-icon-button icon="icons:search" name="search"></paper-icon-button>
          <div class="icon-badge" name="tasks">
            <paper-icon-button icon="icons:check-box" name="tasks" id="tasksCounter"></paper-icon-button>
            <paper-badge label="[[taskCount]]" class="header-badge" for="tasksCounter"></paper-badge>
          </div>
          <paper-icon-button icon="icons:star" name="favorites"></paper-icon-button>
          <paper-icon-button icon="icons:book" name="collections"></paper-icon-button>
          <paper-icon-button icon="icons:folder-shared" name="personalWorkspace"></paper-icon-button>
          <paper-icon-button icon="icons:content-paste" name="clipboard"></paper-icon-button>
          <template is="dom-if" if="[[currentUser.isAdministrator]]">
            <paper-icon-button icon="icons:build" name="administration"></paper-icon-button>
          </template>
          <paper-icon-button icon="icons:account-circle" name="profile" class="profile-icon"></paper-icon-button>
        </paper-menu>

        <iron-collapse id="sidebar" horizontal opened>
          <div>
            <iron-pages selected="[[selectedTab]]" attr-for-selected="name" class="flex">
              <section class="card browse" name="browser">
                <div class="header ellipsis">
                  <h1>[[i18n('heading.app.browse', 'Browse')]]</h1>
                </div>
                <div class="content">
                  <nuxeo-document-tree root-path="/default-domain" current-document="[[currentDocument]]"></nuxeo-document-tree>
                </div>
              </section>

              <section class="card recents" name="recents">
                <div class="header ellipsis">
                  <h1>[[i18n('heading.app.recentlyViewed', 'Recently Viewed')]]</h1>
                </div>
                <div class="content">
                  <nuxeo-recent-documents max-size="5" id="recent"></nuxeo-recent-documents>
                </div>
              </section>

              <section class="card search" name="search">
                <nuxeo-search-form id="searchForm" on-display-filters="_resetSearchResults" dirty="{{dirty}}"
                                   is-saved-search="{{searchLoaded}}" selected-search="{{selectedSearch}}"></nuxeo-search-form>
              </section>

              <section class="card tasks" name="tasks">
                <div class="header ellipsis">
                  <h1>[[i18n('heading.app.tasks', 'Tasks')]]</h1>
                </div>
                <div class="content layout vertical">
                  <nuxeo-tasks-list id="tasks-list" tasks="[[tasks]]" current="[[currentTask]]" class="flex"></nuxeo-tasks-list>
                  <div class="link">
                    <a href$="[[urlFor('tasks')]]">[[i18n('command.app.viewTaskDashboard', '» view Tasks Dashboard')]]</a>
                  </div>
                </div>
              </section>

              <section class="card favorites" name="favorites">
                <div class="header ellipsis">
                  <h1>[[i18n('heading.app.favorites', 'Favorites')]]</h1>
                </div>
                <div class="content">
                  <nuxeo-favorites doc="[[currentDocument]]"></nuxeo-favorites>
                </div>
              </section>

              <section class="card collections" name="collections">
                <nuxeo-collections id="collectionsForm"></nuxeo-collections>
              </section>

              <section class="card personal-space" name="personalWorkspace">
                <div class="header ellipsis">
                  <h1>[[i18n('heading.app.personalSpace', 'Personal Space')]]</h1>
                </div>
                <div class="content">
                  <nuxeo-document-tree id="userWorkspace" root-path="[[_userWorkspacePath]]" current-document="[[currentDocument]]">
                  </nuxeo-document-tree>
                </div>
              </section>

              <section class="card clipboard" name="clipboard">
                <div class="header ellipsis">
                  <h1>[[i18n('heading.app.clipboard', 'Clipboard')]]</h1>
                </div>
                <div class="content">
                  <nuxeo-clipboard id="clipboard" target-document="[[currentDocument]]"></nuxeo-clipboard>
                </div>
              </section>

              <template is="dom-if" if="[[currentUser.isAdministrator]]">
                <section class="card administration" name="administration">
                  <div class="header ellipsis">
                    <h1>[[i18n('heading.app.administration', 'Administration')]]</h1>
                  </div>
                  <div class="content">
                    <iron-selector selected="{{selectedAdminTab}}" attr-for-selected="name">
                      <div class="item" name="analytics">
                        <a href$="[[urlFor('administration', 'analytics')]]">Analytics</a>
                      </div>
                      <div class="item" name="user-group-management">
                        <a href$="[[urlFor('administration', 'user-group-management')]]">[[i18n('label.app.usersAndGroups', 'Users & Groups')]]</a>
                      </div>
                    </iron-selector>
                  </div>
                </section>
              </template>

              <section class="card profile" name="profile">
                <div class="header ellipsis">
                  <h1>[[_displayUser(currentUser)]]</h1>
                </div>
                <div class="content">
                  <div class="item">
                    <a href$="[[urlFor('drive')]]">[[i18n('ui.app.user.drive','Drive')]]</a>
                  </div>
                  <div class="item layout vertical">
                    <a href="[[_connectionUrl()]]/logout">[[i18n('ui.app.user.signOut','Sign Out')]]</a>
                  </div>
                </div>
              </section>
            </iron-pages>
          </div>
        </iron-collapse>
      </div>

      <paper-header-panel main>
        <div class="layout horizontal">

          <iron-pages selected="[[page]]" attr-for-selected="name" class="flex">
            <nuxeo-home name="home"></nuxeo-home>

            <!-- The current document's page -->
            <nuxeo-browser id="browser"
              name="browse"
              document="[[currentDocument]]"
              selected-tab="{{docAction}}"
              clipboard="[[clipboard]]"></nuxeo-browser>

            <nuxeo-search-results id="searchResults" name="search" on-navigate="_navigateFromSearch">
              <div class="actions horizontal layout center">
                <paper-button on-click="_saveSearchAs" hidden$="[[!_showSaveAs(searchDoc,searchLoaded,dirty)]]">
                   <iron-icon icon="add"></iron-icon>[[i18n('ui.app.saveNewSearch', 'Save As')]]
                </paper-button>
                <paper-button on-click="_saveSearch" hidden$="[[!_showSave(searchDoc,searchLoaded,dirty)]]">
                   <iron-icon icon="check"></iron-icon>[[i18n('ui.app.savedSearch', 'Save')]]
                </paper-button>
                <paper-menu-button horizontal-align="right" vertical-offset="40" hidden$="[[!_showOtherSearchActions(searchDoc,searchLoaded,dirty)]]">
                  <paper-icon-button icon="icons:more-vert" class="dropdown-trigger" alt="menu"></paper-icon-button>
                  <paper-menu class="dropdown-content layout vertical">
                    <paper-item class="layout horizontal center" on-tap="_renameSearch">
                      <iron-icon icon="icons:create"></iron-icon>[[i18n('ui.app.renameSearch', 'Rename')]]
                    </paper-item>
                    <paper-item class="layout horizontal center" on-tap="_shareSearch">
                      <iron-icon icon="social:share"></iron-icon>[[i18n('ui.app.shareSearch', 'Share')]]
                    </paper-item>
                  </paper-menu>
                </paper-menu-button>
              </div>
            </nuxeo-search-results>

            <nuxeo-collection-results id="collectionResults"
              name="collection" on-navigate="_navigateFromCollection">
            </nuxeo-collection-results>

            <nuxeo-admin name="admin" selected-tab="[[selectedAdminTab]]" entity="[[entity]]"></nuxeo-admin>

            <div name="tasks">
              <nuxeo-tasks id="tasks-dashboard" tasks="[[tasks]]" current="[[currentTask]]"></nuxeo-tasks>
            </div>

            <!-- Nuxeo Drive page -->
            <paper-header-panel class="flex" name="drive">
              <div class="paper-header layout horizontal">
                <span class="flex">[[i18n('ui.app.drive.heading','Nuxeo Drive')]]</span>
              </div>
              <div class="content">
                <paper-card class="card">
                  <div class="card-content">
                    <span class="title">[[i18n('ui.app.drive.packages','Packages')]]</span>
                    <nuxeo-drive-desktop-packages></nuxeo-drive-desktop-packages>
                  </div>
                </paper-card>
                <paper-card class="card">
                  <div class="card-content">
                    <span class="title">[[i18n('ui.app.drive.roots','Synchronization Roots')]]</span>
                    <nuxeo-drive-sync-roots-management></nuxeo-drive-sync-roots-management>
                  </div>
                </paper-card>
                <paper-card class="card">
                  <div class="card-content">
                    <span class="title">[[i18n('ui.app.drive.tokens','Tokens')]]</span>
                    <nuxeo-authentication-tokens-management application="Nuxeo Drive"></nuxeo-authentication-tokens-management>
                  </div>
                </paper-card>
              </div>
            </paper-header-panel>
          </iron-pages>
        </div>
        <nuxeo-suggester id="suggester"></nuxeo-suggester>
      </paper-header-panel>
    </paper-drawer-panel>

    <nuxeo-document-create-button parent="[[currentParent]]"></nuxeo-document-create-button>

    <iron-a11y-keys
      id="keys"
      keys="ctrl+space"
      target="[[keyPressTarget]]"
      on-keys-pressed="_handleKeyPresses">
    </iron-a11y-keys>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'nuxeo-app',

        properties: {
          baseUrl: {
            type: String,
            value: '/'
          },
          page: {
            type: String,
            observer: '_navigate'
          },

          username: {
            type: String,
            value: 'Administrator'
          },

          selectedTab: {
            type: String,
            observer: '_observeSelectedTab'
          },

          selectedAdminTab: String,

          currentDocument: {
            type: Object,
            observer: '_documentChanged'
          },
          currentParent: Object,
          docPath: String,
          docAction: String,
          linkDocId: String,

          entity: Object,

          tasks: Array,

          searchDoc: Object,

          taskCount: Number,

          drawerWidth: {
            type: String,
            value: '60px'
          },

          drawerOpened: {
            type: Boolean,
            value: false
          },

          keyPressTarget: {
            type: Object,
            value: function() {
              return document.body;
            }
          },

          currentTask: {
            type: Object
          },

          currentUser: {
            type: Object,
            observer: '_observeCurrentUser'

          },

          _userWorkspacePath: {
            type: String
          }

        },

        behaviors: [Nuxeo.RoutingBehavior, Nuxeo.I18nBehavior],

        get docId() {
          return this.linkDocId;
        },

        set docId(id) {
          this.linkDocId = id;
          this.$.idResolver.get().then(function() {
            this.docPath = this.resolvedDocument.path;
            this.linkDocId = '';
            this._navigate();
          }.bind(this));
        },

        listeners: {
          'documentUpdated': 'refresh',
          'nuxeo-content-view-navigate': '_navigateFromCV',
          'goHome': '_handleUGMgoHome',
          'manageUser': '_handleUGMmanageUser',
          'manageGroup': '_handleUGMmanageGroup',
          'browseCollection': '_navigateToCollection',
          'workflowStarted': '_fetchTasks',
          'workflowTaskProcessed': '_fetchTasks',
          'taskChanged': '_onTaskChanged',
          'addToClipboard': '_onAddToClipboard',
          'addedToCollection': '_documentAddedToCollection',
          'removedFromCollection': '_documentRemovedFromCollection'
        },

        ready: function() {
          this.clipboard = this.$.clipboard;
          this._fetchTasks();
          this.$.searchResults.nxProvider = this.$.searchForm.nxProvider;
          this.$.collectionResults.nxProvider = this.$.collectionsForm.nxProvider;
          if (this.shadowRoot) {
            var experimental = document.createElement('div');
            experimental.innerHTML = 'shadow dom enabled';
            experimental.className = 'experimental';
            Polymer.dom(this.root).appendChild(experimental);
          }
          this.$.nxcon.connect().then(function(res) {
            this.currentUser =  res;
          }.bind(this));
        },

        refresh: function() {
          this.$.doc.get();
        },

        _showSaveAs: function() {
          return this.searchLoaded || (!this.searchLoaded && this.dirty);
        },

        _showSave: function() {
          return this.searchLoaded && this.dirty && this._hasPermissions();
        },

        _showOtherSearchActions: function() {
          return this.searchLoaded && this._hasPermissions();
        },

        _hasPermissions: function() {
          return this.searchDoc ? (this.searchDoc.contextParameters.permissions.indexOf('Write') > -1 ||
                  this.searchDoc.contextParameters.permissions.indexOf('Everything') > -1) : false;
        },

        _navigate: function() {
          var url = '/' + this.page, state;
          if (this.page === 'browse') {
            if (this.docPath) {
              url += this.docPath;
            }
            if (this.docAction) {
              url += '@' + this.docAction;
            }
            if (this.currentContentView) {
              state = {contentView: this.currentContentView.provider};
            }
          } else if (this.page === 'admin') {
            if (this.selectedAdminTab) {
              url += '/' + this.selectedAdminTab;
              if (this.selectedAdminTab === 'user-group-management' &&
                  this.entity && this.entity.id && this.entity.type) {
                url += '/' + this.entity.type + '/' + this.entity.id;
              }
            }
          }
          page.show(url, state);
          this.fire('navigation', {page: this.page});
        },

        _navigateFromCV: function(e) {
          this.currentContentView = Polymer.dom(e).rootTarget;
          page.show('/browse' + this.currentContentView.currentDocument.path,
                    {contentView: this.currentContentView.provider});
        },

        _navigateFromSearch: function(e) {
          page.show('/browse' + e.detail.doc.path);
          this.$.searchForm.displayQueue(e.detail.doc, e.detail.index);
        },

        _navigateFromCollection: function(e) {
          page.show('/browse' + e.detail.doc.path);
          this.$.collectionsForm.displayMembers(e.detail.doc, e.detail.index);
        },

        _resetSearchResults: function() {
          this.selectedTab = 'search';
          this.page = 'search';
        },

        _navigateToCollection: function(e) {
          this.selectedTab = 'collections';
          this.page = 'collection';
          this.$.collectionResults.headerLabel = e.detail.collection.title;
        },

        get currentContentView() {
          return this.$.browser.currentContentView;
        },

        set currentContentView(cv) {
          this.$.browser.currentContentView = cv;
        },

        scrollPageToTop: function() {
          //this.$.selectedPage.scrollToTop(true);
        },

        _documentChanged: function() {
          if (this.currentDocument) {
            this.$.recent.add(this.currentDocument);
            this.currentParent = this.currentDocument.facets.indexOf('Folderish') > -1 ? this.currentDocument :
              this.currentDocument.contextParameters.breadcrumb.entries.slice(-2,-1)[0];
          }
        },

        _toggleDrawer: function(e) {
          if (this._selected === e.detail.selected && this.drawerOpened) {
            this.drawerWidth = '60px';
            this.drawerOpened = false;
          } else {
            this.drawerWidth = '350px';
            this.$.sidebar.style.width = '100%';
            this.drawerOpened = true;
          }
          this._selected = e.detail.selected;
        },

        _handleKeyPresses: function() {
          this.$.suggester.toggle();
        },

        _handleUGMgoHome: function() {
          this.entity = {};
          this._navigate();
        },

        _handleUGMmanageUser: function(e) {
          this.entity = {type: 'user', id: e.detail.user};
          this._navigate();
        },

        _handleUGMmanageGroup: function(e) {
          this.entity = {type: 'group', id: e.detail.group};
          this._navigate();
        },

        _observeSelectedTab: function() {
          if (this.selectedTab === 'search') {
            this.page = this.selectedTab;
          }
        },

        _fetchTasks: function() {
          // hack to fetch tasks with user prefix and without prefix
          // some tasks are prefixed, to be reviewed later
          this._tmpTasks = [];
          this.$.tasks.params = {'userId': this.username};
          this.$.tasks.get().then(function(response) {
            this._tmpTasks = response.entries;
            this.$.tasks.params = {'userId': 'user:' + this.username};
            this.$.tasks.get().then(function(response) {
              this.tasks = this._tmpTasks.concat(response.entries);
              this.taskCount = this.tasks.length;
            }.bind(this));
          }.bind(this));
        },

        _onTaskChanged: function(e) {
          this.page = 'tasks';
          this.currentTask = e.detail.task;
        },

        _saveSearch: function() {
          this.$$('nuxeo-search-form').save();
        },

        _saveSearchAs: function() {
          this.$$('nuxeo-search-form').saveAs();
        },

        _renameSearch: function() {
          this.$$('nuxeo-search-form').rename();
        },

        _shareSearch: function() {
          this.$$('nuxeo-search-form').share();
        },

        _onAddToClipboard: function(e) {
          if (e.detail.documents) {
            e.detail.documents.forEach(function(doc) {
              if (!this.clipboard.contains(doc)) {
                this.clipboard.add(doc);
              }
            }.bind(this));
          }
        },

        _observeCurrentUser: function() {
          if (this.currentUser) {
            this._userWorkspacePath =  '/default-domain/UserWorkspaces/' + this.currentUser.id;
          }
        },

        _displayUser: function(user) {
          if (user) {
            var result = '';
            if (user.properties['firstName']) {
              result += user.properties['firstName'];
            }
            if (user.properties['lastName']) {
              if (result.length > 0) {
                result += ' ';
              }
              result += user.properties['lastName'];
            }
            if (result.length === 0) {
              result = user.id;
            }
            return result;
          }
        },

        _connectionUrl: function() {
          return this.$.nxcon.url;
        },

        _documentAddedToCollection: function(e) {
          if (e.detail.docIds) {
            this.$.toast.text = this.i18n('documents_added_to_collection', 'Documents added to collection.');
          } else {
            this.$.toast.text = this.i18n('document_added_to_collection', 'Document added to collection.');
          }
          this.$.toast.open();
        },

        _documentRemovedFromCollection: function() {
          this.$.toast.text = this.i18n('document_removed_from_collection', 'Document removed from collection.');
          this.$.toast.open();
        }

      });
    })();
  </script>

</dom-module>
