<!--
(C) Copyright 2015 Nuxeo SA (http://nuxeo.com/) and contributors.

All rights reserved. This program and the accompanying materials
are made available under the terms of the GNU Lesser General Public License
(LGPL) version 2.1 which accompanies this distribution, and is available at
http://www.gnu.org/licenses/lgpl.html

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
Lesser General Public License for more details.

Contributors:
  Nelson Silva <nsilva@nuxeo.com>
  Andre Justo <ajusto@nuxeo.com>
  Guillaume Renard <grenard@nuxeo.com>
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<!--
 `nuxeo-collections`
 @group Nuxeo UI
 @element nuxeo-collections
 -->
<dom-module id="nuxeo-collections">
  <template>
    <style is="custom-style" include="shared-styles">
    :host {
      @apply(--layout-vertical);
      @apply(--layout-flex);
      display: block;
    }
    .scrollThreshold {
      /* scrollThreshold has to have
         an explicit height else infinite
         scrolling breaks */
      height: calc(100vh - 61px);
    }
    .list-item {
      cursor: pointer;
      padding: 1em;
      border-bottom: 1px solid #DDD;
    }
    .list-item:focus,
    .list-item.selected:focus {
      outline: 0;
      background-color: #ddd;
    }
    .list-item.selected {
      color: var(--paper-blue-600);
    }
    .list-item.selected {
      background-color: var(--google-grey-300);
      border-bottom: 1px solid #ccc;
    }
    .manualLoading {
      color: var(--nuxeo-link-color);
      text-align: center;
    }

    .manualLoading:hover {
      cursor: pointer;
      color: var(--nuxeo-link-hover-color);
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
    }

    .collections {
      height: calc(100vh - 61px);
      overflow: auto;
    }

    .remove {
      width: 16px;
      height: 16px;
      border-radius: 8px;
    }

    .switch {
      position: absolute;
      top: 0;
      right: 0;
      width: 60px;
      height: 60px;
      padding: 16px;
      z-index: 101;
      border: var(--nuxeo-border);
      background-color: var(--nuxeo-light-background);
    }

    .switch:hover,
    .remove:hover {
      background-color: var(--nuxeo-button-primary);
      color: var(--nuxeo-button-primary-text);
    }

    /* TODO for Lise,need to factorize the following with nuxeo-app styles*/
    .content {
      font-size: .9rem;
      @apply(--layout-flex);
      @apply(--layout-vertical);
      height: calc(100vh - 61px);
      width: 290px;
    }

    .header {
      height: 59px;
      background-color: var(--nuxeo-light-background);
      border-bottom: var(--nuxeo-border);
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }

    .header h1 {
      color: var(--nuxeo-tag-text);
      text-transform: uppercase;
      font-size: 1rem;
      margin: .1em .2em 0 1.1em;
      font-weight: 500;
    }
    /* End TODO Lise :) */

    .collection-box {
      line-height: 155%;
    }

    .collection-box + .collection-box {
      border-top: var(--nuxeo-border);
    }

    iron-icon.collection-name-icon {
      --iron-icon-height: .9em;
      --iron-icon-width: .9em;
      border-radius: 50px;
      background-color: var(--nuxeo-secondary-color);
      color: white;
      padding: .4em;
    }

    .collection-name {
      font-weight: 700;
      margin-left: .5em;
    }

    .collection-detail {
      margin-left: 2.2em;
    }

    .collection-property {
      color: var(--nuxeo-text-light);
      margin-right: .2em;
    }

    .date {
      color: var(--nuxeo-warn-text);
    }

    </style>

    <nuxeo-connection id="nxcon"></nuxeo-connection>

    <nuxeo-operation op="Collection.RemoveFromCollection"
                     id="removeFromCollectionOp">
    </nuxeo-operation>

    <paper-toast id="toast"></paper-toast>

    <div class="header ellipsis search-header">
      <template is="dom-if" if="[[_isDisplayMembers]]">
        <h1>[[selectedCollection.title]]</h1>
        <paper-icon-button class="switch" icon="icons:arrow-back" id="backToCollections" on-tap="displayCollections">
        </paper-icon-button>
        <paper-tooltip for="backToCollections">[[i18n('display_filter', 'Back to all collections')]]</paper-tooltip>
      </template>
      <template is="dom-if" if="[[!_isDisplayMembers]]">
        <h1>[[i18n('collections', 'Collections')]]</h1>
      </template>
    </div>


      <neon-animated-pages class="content" id="queues" selected="[[_selectedPage]]" entry-animation="[[_entryAnimation]]" exit-animation="[[_exitAnimation]]">
        <neon-animatable>

          <div id="collections" class="collections" hidden$="{{_isDisplayMembers}}">
            <nuxeo-page-provider id="collectionsProvider" auto
               provider="user_collections"
               page-size="40"
               params='{"searchTerm":"%","user":"$currentUser"}'
               sort='{"dc:modified":"desc"}'
               on-update="_updateCollectionResults">
            </nuxeo-page-provider>
            <iron-scroll-threshold id="collectionsScrollThreshold"
              lower-threshold="800" hidden$="[[!hasCollection]]"
              class="scrollThreshold"
              on-lower-threshold="_loadMoreCollections">
              <iron-list id="collectionsList" items="[[collections]]"
                selected-item="{{selectedCollection}}"
                selection-enabled
                scroll-target="collectionsScrollThreshold" as="collection">
                <template>
                  <div tabindex$="{{tabIndex}}" class$="[[_computedClass(selected)]]">
                    <div class="collection-box vertical layout">
                      <div class="collection-info horizontal layout center">
                        <div class="vertical layout center">
                          <iron-icon class="collection-name-icon" icon="icons:book"></iron-icon>
                        </div>
                        <span class="collection-name">[[collection.title]]</span>
                      </div>
                      <div class="collection-detail">
                        <div class="date horizontal layout center">
                          <span class="collection-property">[[i18n('last_updated', 'Last updated on ')]] </span>
                          <span>[[_formatDate(collection.properties.dc:modified)]]</span>
                        </div>
                        <div class="layout center">
                          <span class="collection-property">[[i18n('owned_by', 'Owned by')]] </span>
                          <a class="tag user" href$="[[urlFor('user', collection.properties.dc:creator)]]">[[collection.properties.dc:creator]]</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>
              </iron-list>
              <template is="dom-if" if="[[showMoreCollections]]">
                <div class="list-item loading">
                  <div class="primary">
                    <paper-spinner class="nxicon" active="true"></paper-spinner>
                    [[i18n('loading_more', 'Loading more data')]]
                  </div>
                </div>
              </template>
            </iron-scroll-threshold>
            <div hidden$="[[hasCollection]]">
              <span class="empty">[[i18n('no_collections', 'No collections.')]]</span>
            </div>
          </div>

        </neon-animatable>

        <neon-animatable>

          <div id="queue" hidden$="{{!_isDisplayMembers}}">
            <nuxeo-page-provider id="memberProvider"
               provider="default_content_collection"
               enrichers="thumbnail"
               is-next-page-available="{{isNextPageAvailable}}"
               current-page-size="{{currentPageSize}}"
               on-update="_updateMemberResults">
            </nuxeo-page-provider>
            <iron-scroll-threshold id="membersScrollThreshold"
              class="scrollThreshold"
              lower-threshold="800" hidden$="[[!hasMember]]"
              on-lower-threshold="_loadMoreMembers">
              <iron-list id="membersList" items="[[members]]" selected-item="{{selectedMember}}" selection-enabled scroll-target="membersScrollThreshold" as="member">
                <template>
                  <div tabindex$="{{tabIndex}}" class$="[[_computedClass(selected)]]">
                    <div class="list-item-box vertical layout">
                      <div class="list-item-info horizontal layout center">
                        <div class="vertical layout center">
                          <img class="queue-thumbnail" src="[[_thumbnail(member)]]">
                        </div>
                        <span class="list-item-title ellipsis">[[member.title]]</span>
                      </div>
                      <div class="list-item-detail">
                        <div class="layout center">
                          <span class="list-item-property ellipsis">
                            [[member.type]]
                            <iron-icon  id="removeFromCollection" class="remove"
                              icon="icons:clear" data-uid$="[[member.uid]]" on-tap="_removeFromCollection">
                            </iron-icon>
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>
              </iron-list>
              <template is="dom-if" if="[[showMoreMembers]]">
                <div class="list-item loading">
                  <div class="primary">
                    <paper-spinner class="nxicon" active="true"></paper-spinner>
                    [[i18n('loading_more', 'Loading more data')]]
                  </div>
                </div>
              </template>
            </iron-scroll-threshold>
            <div hidden$="[[hasMember]]">
              <span class="empty">[[i18n('empty_collection', 'Empty collection')]]</span>
            </div>
          </div>

        </neon-animatable>
      </neon-animated-pages>


  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'nuxeo-collections',

        properties: {

          selectedSearch: {
            type: String,
            value: 'faceted'
          },

          currentIndex: {
            type: Number,
            notify: true
          },
          _isDisplayMembers: {
            type: Boolean,
            value: false,
            observer: '_observeIsDisplayMembers'
          },
          collections: {
            type: Object,
            value: []
          },
          members: {
            type: Object,
            value: []
          },
          showMoreCollections: {
            type: Object,
            value: false
          },
          showMoreMembers: {
            type: Object,
            value: false
          },
          selectedCollection: {
            type: Object,
            observer: '_selectedCollectionChanged',
            notify: true
          },
          selectedMember: {
            type: Object,
            observer: '_selectedMemberChanged',
            notify: true
          },
          hasCollection: {
            type: Boolean,
            value: true
          },
          hasMember: {
            type: Boolean,
            value: true
          },
          keyEventTarget: {
            type: Object,
            value: function() {
              return document.body;
            }
          },
          _entryAnimation: {
            type: String,
            value: 'slide-from-right-animation'
          },
          _exitAnimation: {
            type: String,
            value: 'slide-left-animation'
          }
        },

        behaviors: [
          Polymer.IronA11yKeysBehavior
        ],

        keyBindings: {
          'right': '_navigateOnRight',
          'l': '_navigateOnRight',
          'left': '_navigateOnLeft',
          'h': '_navigateOnLeft',
          'down': '_navigateOnDown',
          'j': '_navigateOnDown',
          'up': '_navigateOnUp',
          'k': '_navigateOnUp'
        },

        _navigateOnRight: function() {
          if (!this._isDisplayMembers) {
            if (this.selectedCollection) {
              this.displayMembers();
              this.$.membersScrollThreshold.clearTriggers();
              this.$.membersList.fire('iron-resize');
              if (this.hasMember) {
                this.$.membersList.selectItem(0);
              }
            }
            this._tmpJustRight = true;
          }
        },

        _navigateOnLeft: function() {
          if (this._isDisplayMembers) {
            this.displayCollections();
            this.$.collectionsScrollThreshold.clearTriggers();
            this.$.collectionsList.fire('iron-resize');
          }
          this._tmpJustLeft = true;
        },

        _navigateOnDown: function() {
          if (this._isDisplayMembers) {
            if (this._tmpJustRight) {
              this.$.membersList.selectQueueNext();
              this._tmpJustRight = false;
            }
          } else {
            if (this._tmpJustLeft) {
              this.$.collectionsList.selectQueueNext();
              this._tmpJustLeft = false;
            }
          }
        },

        _navigateOnUp: function() {
          if (this._isDisplayMembers) {
            if (this._tmpJustRight) {
              this.$.membersList.selectQueuePrevious();
              this._tmpJustRight = false;
            }
          } else {
            if (this._tmpJustLeft) {
              this.$.collectionsList.selectQueuePrevious();
              this._tmpJustLeft = false;
            }
          }
        },

        _observeIsDisplayMembers: function() {
          if (this._isDisplayMembers) {
            this._entryAnimation = 'slide-from-right-animation';
            this._exitAnimation = 'slide-left-animation';
            this._selectedPage = 1;
          } else {
            this._entryAnimation = 'slide-from-left-animation';
            this._exitAnimation = 'slide-right-animation';
            this._selectedPage = 0;
          }
        },

        _updateCollectionResults: function() {
          var collections = this.$.collectionsProvider.currentPage;
          collections.forEach(function(collection) {
            this.push('collections', collection);
          }.bind(this));
          this.$.collectionsList.fire('iron-resize');
          this.hasCollection = !(this.collections && this.collections.length === 0);
          this.showMoreCollections = this.$.collectionsProvider.isNextPageAvailable;
          this.$.collectionsScrollThreshold.clearTriggers();
        },

        _resetCollectionResults: function() {
          this.$.collectionsProvider.page = 1;
          this.$.collectionsProvider.pageSize = 40;
          this.collections = [];
          this.selectedCollection = null;
          this.displayCollections();
          this.$.collectionsList.fire('iron-resize');
          this.showMoreCollections = false;
          this.$.collectionsScrollThreshold.clearTriggers();
          this.fire('resetCollectionResults');
        },

        _updateMemberResults: function() {
          var memberResults = this.$.memberProvider.currentPage;
          memberResults.forEach(function(member) {
            this.push('members', member);
          }.bind(this));
          this.$.membersList.fire('iron-resize');
          this.hasMember = !(this.members && this.members.length === 0);
          this.showMoreMembers = this.$.memberProvider.isNextPageAvailable;
          this.$.membersScrollThreshold.clearTriggers();
          this.fire('initCollectionResults', {
            provider: this.$.memberProvider,
          });
        },

        _resetMemberResults: function() {
          this.$.memberProvider.page = 1;
          this.$.memberProvider.pageSize = 40;
          this.members = [];
          this.selectedMember = null;
          this.displayCollections();
          this.$.membersList.fire('iron-resize');
          this.showMoreMembers = false;
          this.$.membersScrollThreshold.clearTriggers();
          this.fire('resetCollectionResults');
        },

        displayMembers: function(member, index) {
          this._isDisplayMembers = true;
          if (member && member.uid) {
            this.$.membersList.selectItem(member);
            this.$.membersList.scrollToIndex(Math.max(0, index - 5));
          }
        },

        displayCollections: function() {
          this._isDisplayMembers = false;
          this.fire('browseCollection', {
            collection: this.selectedCollection,
          });
        },

        _loadMoreCollections: function() {
          if (this.$.collectionsProvider) {
            if (this.$.collectionsProvider.isNextPageAvailable) {
              this.$.collectionsProvider.page = this.$.collectionsProvider.page + 1;
            }
          }
        },

        _loadMoreMembers: function() {
          if (this.$.memberProvider) {
            if (this.$.memberProvider.isNextPageAvailable) {
              this.$.memberProvider.page = this.$.memberProvider.page + 1;
              this.$.memberProvider.fetch();
            }
          }
        },

        _removeFromCollection: function(evt) {
          var op = this.$.removeFromCollectionOp;
          var memberId = evt.currentTarget.dataset.uid;
          op.input = memberId;
          op.params = {
            'collection': this.selectedCollection
          };
          op.execute().then(function() {
            var memberIndex;
            this.members = this.members.filter(function(el, index) {
              if (el.uid === evt.target.dataset.uid) {
                memberIndex = index;
                return false;
              }
              return true;
            });
            this.$.membersList.selectItem(memberIndex);
            this.$.toast.text = 'Document removed from Collection.';
            this.$.toast.open();
            this.fire('removedFromCollection',
              {
                innerRemove: true,
                docId: memberId,
                collectionId: evt.target.dataset.uid

              }
            );
          }.bind(this));
        },

        _computedClass: function(isSelected) {
          var classes = 'list-item';
          if (isSelected) {
            classes += ' selected';
          }
          return classes;
        },

        _selectedMemberChanged: function(member) {
          if (member) {
            page.show('/browse' + member.path);
          }
        },

        _selectedCollectionChanged: function(collection) {
          if (collection) {
            this._resetMemberResults();
            this.fire('browseCollection', {
              collection: collection,
            });
            this.$.memberProvider.params = [collection.uid];
            this.$.memberProvider.fetch();
          }
        },

        _icon: function(doc) {
          var url = this.$.nxcon.url;
          return url + doc.properties['common:icon'];
        },

        _thumbnail: function(doc) {
          if (doc.contextParameters.thumbnail.url) {
            return doc.contextParameters.thumbnail.url;
          } else {
            var baseUrl = this.$.nxcon.url;
            return baseUrl + '/nxthumb/default/' + doc.uid + '/blobholder:0/';
          }
        },

        _isEmpty: function(items) {
          return items && items.length === 0;
        },

        ready: function() {
          window.addEventListener('addedToCollection', function() {
            this.collections = [];
            this.$.collectionsProvider.fetch();
          }.bind(this));
          window.addEventListener('removedFromCollection', function(e) {
            if (e.detail.innerRemove) {
              return;
            }
            this.collections = [];
            this.$.collectionsProvider.fetch();
          }.bind(this));

          // tmp fix
          // see https://github.com/PolymerElements/iron-list/issues/236
          this.$.collectionsList._didMoveDown = function() {
            this._focusPhysicalItem(this._focusedIndex + 1);
          };
          this.$.membersList._didMoveDown = function() {
            this._focusPhysicalItem(this._focusedIndex + 1);
          };
          // end tmp fix

          this.$.collectionsList.selectQueuePrevious = function() {
            this._didMoveUp();
            this.toggleSelectionForFocusedItem();
          };
          this.$.collectionsList.selectQueueNext = function() {
            this._didMoveDown();
            this.toggleSelectionForFocusedItem();
          };
          this.$.collectionsList.toggleSelectionForFocusedItem = function() {
            this.debounce('toggleSelectionForFocusedItem', function() {
              var model = this._focusedItem._templateInstance;
              if (model) {
                this.toggleSelectionForItem(model[this.as]);
              }
            }.bind(this), 300);
          };
          this.$.collectionsList.addOwnKeyBinding('up', 'toggleSelectionForFocusedItem');
          this.$.collectionsList.addOwnKeyBinding('k', 'selectQueuePrevious');
          this.$.collectionsList.addOwnKeyBinding('down', 'toggleSelectionForFocusedItem');
          this.$.collectionsList.addOwnKeyBinding('j', 'selectQueueNext');

          this.$.membersList.selectQueuePrevious = function() {
            this._didMoveUp();
            this.toggleSelectionForFocusedItem();
          };
          this.$.membersList.selectQueueNext = function() {
            this._didMoveDown();
            this.toggleSelectionForFocusedItem();
          };
          this.$.membersList.toggleSelectionForFocusedItem = function() {
            this.debounce('toggleSelectionForFocusedItem', function() {
              var model = this._focusedItem._templateInstance;
              if (model) {
                this.toggleSelectionForItem(model[this.as]);
              }
            }.bind(this), 300);
          };
          this.$.membersList.addOwnKeyBinding('up', 'toggleSelectionForFocusedItem');
          this.$.membersList.addOwnKeyBinding('k', 'selectQueuePrevious');
          this.$.membersList.addOwnKeyBinding('down', 'toggleSelectionForFocusedItem');
          this.$.membersList.addOwnKeyBinding('j', 'selectQueueNext');
        },

        _formatDate: function(date) {
          return moment(date).format('MMMM D, YYYY');
        }

      });
    })();
  </script>
</dom-module>
