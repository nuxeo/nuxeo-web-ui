<!--
(C) Copyright 2016 Nuxeo SA (http://nuxeo.com/) and contributors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Contributors:
    Andre Justo <ajusto@nuxeo.com>
    Gabriel Barata <gbarata@nuxeo.com>
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/nuxeo-ui-elements/nuxeo-i18n-behavior.html">

<!--
 `nuxeo-search-form`
 @group Nuxeo UI
 @element nuxeo-search-form
 -->
<dom-module id="nuxeo-search-form">
  <template>
    <style is="custom-style" include="shared-styles">
    :host {
      @apply(--layout-vertical);
      @apply(--layout-flex);
      display: block;
    }
    #scrollTheshold {
      /* scrollTheshold has to have
         an explicit height else infinite
         scrolling breaks */
      height: calc(100vh - 61px);
    }

    .filters {
      padding: 1em 0;
      height: calc(100vh - 61px);
      overflow: auto;
    }

    .switch {
      position: absolute;
      top: 0;
      right: 0;
      width: 60px;
      height: 60px;
      padding: 16px;
      z-index: 101;
      border: var(--nuxeo-border);
      background-color: var(--nuxeo-light-background);
    }

    .switch:hover {
      background-color: var(--nuxeo-button-primary);
      color: var(--nuxeo-button-primary-text);
    }

    paper-dropdown-menu {
      margin-left: 1em;
    }

    ::content .unfocused-line.paper-input-container {
      background-color: transparent;
    }

    /* TODO for Lise,need to factorize the following with nuxeo-app styles*/
    .content {
      font-size: .9rem;
      @apply(--layout-flex);
      @apply(--layout-vertical);
      height: calc(100vh - 61px);
      width: 290px;
    }

    .header {
      height: 59px;
      background-color: var(--nuxeo-light-background);
      border-bottom: var(--nuxeo-border);
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }

    .header h1 {
      font-size: 1rem;
      margin: .1em .2em 0 1.1em;
      font-weight: 500;
    }

    .header h1,
    .header ::content .input-content.paper-input-container input {
      color: var(--nuxeo-tag-text);
      text-transform: uppercase;
    }
    /* End TODO Lise :) */

    .row {
      box-sizing: border-box;
      margin-bottom: 1rem;
      padding: 0 1rem;
      width: 100%;
    }

    .clear {
      background-color: #fafafa;
      border-color: #fafafa;
      width: 100%;
    }

    .reset {
      width: 100%;
    }

    #saveDialog,
    #renameDialog {
      width: 400px;
    }

    :host[loading] .loadable {
      opacity: 0.25;
    }

    :host[loading] paper-spinner-lite {
      position: absolute;
      top: 45%;
      left: 50%;
      --paper-spinner-color: var(--default-primary-color);
    }
    </style>

    <nuxeo-connection id="nxcon"></nuxeo-connection>
    <nuxeo-page-provider id="provider" auto
       provider="[[provider]]"
       aggregations="{{aggregations}}"
       enrichers="thumbnail"
       current-page="{{currentPage}}"
       is-next-page-available="{{isNextPageAvailable}}"
       current-page-size="{{currentPageSize}}"
       params="[[params]]"
       on-update="_updateSearchResults">
    </nuxeo-page-provider>

    <nuxeo-search id="saved-search"></nuxeo-search>

    <div class="header ellipsis search-header">
      <nuxeo-search id="saved-searches" auto searches="{{searches}}" params="[[_computeSavedSearchesParams(provider)]]"></nuxeo-search>
      <paper-dropdown-menu id="actionsDropdown" no-label-float horizontal-align="left">
        <paper-menu class="dropdown-content" selected="{{selectedSearchIdx}}">
          <paper-item>[[i18n('ui.searchForm.searchFilters', 'Search Filters')]]</paper-item>
          <template is="dom-repeat" items="[[searches]]" as="search">
            <paper-item>[[search.title]]</paper-item>
          </template>
        </paper-menu>
      </paper-dropdown-menu>
      <template is="dom-if" if="[[_isQueue]]">
        <paper-icon-button class="switch" icon="editor:border-color" id="toogleFilter" on-tap="displayFilters">
        </paper-icon-button>
        <paper-tooltip for="toogleFilter">[[i18n('ui.searchForm.displayFilterView', 'Switch to filter view')]]</paper-tooltip>
      </template>
      <template is="dom-if" if="[[!_isQueue]]">
        <paper-icon-button class="switch" icon="icons:list" id="toogleQueue" on-tap="displayQueue">
        </paper-icon-button>
        <paper-tooltip for="toogleQueue">[[i18n('ui.searchForm.displayQueueView', 'Switch to queue view')]]</paper-tooltip>
      </template>
    </div>

    <div class="content">

      <div id="filters" class="filters loadable" hidden$="{{_isQueue}}">
        <div id="search-form-container">
          <!-- Dynamic search form element will be inserted here -->
          <!-- <nuxeo-{{searchName}}-search aggregations="[[aggregations]]" params="{{params}}"> -->
        </div>
        <div class="layout vertical row">
          <paper-button noink class="primary clear" raised on-click="_clear">
            [[i18n('ui.searchForm.clear', 'Clear')]]
          </paper-button>
        </div>
        <div class="layout vertical row" hidden$="[[!_isSavedSearch(selectedSearchIdx)]]">
          <paper-button noink class="reset" disabled$="[[!dirty]]" raised on-click="_reset">
            [[i18n('ui.searchForm.Reset', 'Reset')]]
          </paper-button>
        </div>
      </div>

      <div id="queue" hidden$="{{!_isQueue}}">
        <iron-scroll-threshold id="scrollTheshold"
          lower-threshold="800" hidden$="[[!hasResults]]"
          on-lower-threshold="_loadMoreData">
          <iron-list id="itemsList" items="[[docItems]]"
            class="loadable"
            selected-item="{{selectedDocument}}"
            selection-enabled
            scroll-target="scrollTheshold">
            <template>
              <div tabindex$="{{tabIndex}}" class$="[[_computedClass(selected)]]">
                <div class="list-item-box vertical layout">
                  <div class="list-item-info horizontal layout center">
                    <div class="vertical layout center">
                      <img class="queue-thumbnail" src="[[_thumbnail(item)]]">
                    </div>
                    <span class="list-item-title ellipsis">[[item.title]]</span>
                  </div>
                  <div class="list-item-detail">
                    <div class="layout center">
                      <span class="list-item-property ellipsis">
                        [[item.type]]
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </iron-list>
        </iron-scroll-threshold>
        <div hidden$="[[hasResults]]" class="noResult">
          <span class="empty">[[i18n('ui.searchForm.noResult', 'No result found')]]</span>
        </div>
      </div>
    </div>

    <paper-spinner-lite active hidden=[[!loading]]></paper-spinner-lite>

    <paper-dialog id="saveDialog" with-backdrop>
      <div class="vertical layout">
        <h1>[[i18n('ui.searchForm.savePopup.heading','Save Search')]]</h1>
        <div>
          <paper-input id="savedSearchTitle"
                       label="[[i18n('ui.searchForm.savePopup.label', 'Enter a name for your saved search')]]"
                       autofocus
                       no-label-float>
          </paper-input>
        </div>
        <div class="buttons">
         <paper-button dialog-dismiss>[[i18n('command.cancel', 'Cancel')]]</paper-button>
         <paper-button noink class="primary" on-tap="_saveSearch">[[i18n('ui.searchForm.popup.save','Save')]]</paper-button>
        </div>
      </div>
    </paper-dialog>

    <paper-dialog id="renameDialog" with-backdrop>
      <div class="vertical layout">
        <h1>[[i18n('ui.searchForm.renamePopup.heading', 'Rename Saved Search')]]</h1>
        <div>
          <paper-input id="savedSearchRenameTitle"
                       label="[[i18n('ui.searchForm.renamePopup.label', 'Enter a new name for your saved search')]]"
                       autofocus
                       no-label-float>
          </paper-input>
        </div>
        <div class="buttons">
         <paper-button dialog-dismiss>[[i18n('command.cancel', 'Cancel')]]</paper-button>
         <paper-button noink class="primary" on-tap="_saveSearch">[[i18n('ui.searchForm.popup.save','Save')]]</paper-button>
        </div>
      </div>
    </paper-dialog>

    <paper-dialog id="shareDialog" with-backdrop>
      <div class="vertical layout">
        <h1>[[i18n('ui.searchForm.shared.heading', 'Share Saved Search')]]</h1>
        <nuxeo-document-permissions doc-id="[[selectedSearch.id]]"></nuxeo-document-permissions>
        <div class="buttons">
         <paper-button dialog-dismiss>[[i18n('command.close', 'Close')]]</paper-button>
        </div>
      </div>
    </paper-dialog>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'nuxeo-search-form',

        behaviors: [Nuxeo.I18nBehavior],

        properties: {
          selectedSearch: {
            type: Object,
            notify: true,
            observer: '_selectedSearchChanged'
          },
          selectedSearchIdx: {
            type: Number,
            value: 0,
            observer: '_selectedSearchIdxChanged'
          },
          provider: {
            type: String,
            value: 'default_search'
          },
          params: {
            type: Object
          },
          currentIndex: {
            type: Number,
            notify: true
          },
          _isQueue: {
            type: Boolean,
            value: false
          },
          docItems: {
            type: Array,
            value: []
          },
          selectedDocument: {
            type: Object,
            observer: '_selectedDocChanged',
            notify: true
          },
          hasResults: {
            type: Boolean,
            value: true
          },
          dirty: {
            type: Boolean,
            value: false,
            notify: true
          },
          isSavedSearch: {
            type: Boolean,
            value: false,
            notify: true
          },
          paramMutator: {
            type: Function,
            value: function() {
              return function(params) {
                var result = {};
                if (params) {
                  // filter null values
                  for (var param in params) {
                    var value = params[param];
                    if (value && param !== 'dc:title') {
                      result[param.startsWith('defaults:') ? param.replace('defaults:', '') : param] = value;
                    }
                  }
                  // allow search to be visible on JSF UI
                  if (!('cvd:contentViewName' in result)) {
                    result['cvd:contentViewName'] = 'default_search';
                  }
                }
                return result;
              };
            }
          },
          loading: {
            type: Boolean,
            notify: true,
            reflectToAttribute: true,
            value: false
          },
          searchName: String,
          aggregations: {
            type: Object,
            observer: '_aggregationsChanged'
          }
        },

        observers: [
          '_resetResults(provider, params.*)',
          '_paramsChanged(params.*)'
        ],

        get nxProvider() {
          return this.$.provider;
        },

        _updateSearchResults: function() {
          if (this.$.provider.page === 1) {
            this.docItems = [];
          }
          var docs = this.$.provider.currentPage;
          docs.forEach(function(doc) {
            this.push('docItems', doc);
          }.bind(this));
          this.$.itemsList.fire('iron-resize');
          this.hasResults = !(this.docItems && this.docItems.length === 0);
          this.$.scrollTheshold.clearTriggers();
          this.loading = false;
        },

        _resetResults: function() {
          this.$.provider.page = 1;
          this.$.provider.pageSize = 40;
          this.docItems = [];
          this.selectedDocument = null;
          this._isQueue = false;
          this.$.itemsList.fire('iron-resize');
          this.$.scrollTheshold.clearTriggers();
          this.loading = true;
        },

        displayQueue: function(doc, index) {
          this._isQueue = true;
          if (doc && doc.uid) {
            this.$.itemsList.selectItem(doc);
            this.$.itemsList.scrollToIndex(Math.max(0, index - 5));
          }
        },

        displayFilters: function() {
          this._isQueue = false;
          this.fire('display-filters');
        },

        _loadMoreData: function() {
          if (this.$.provider) {
            if (this.$.provider.isNextPageAvailable) {
              this.$.provider.page = this.$.provider.page + 1;
              this.loading = true;
            }
          }
        },

        _computedClass: function(isSelected) {
          var classes = 'list-item';
          if (isSelected) {
            classes += ' selected';
          }
          return classes;
        },

        _selectedDocChanged: function(doc) {
          if (doc) {
            page.show('/browse' + doc.path);
          }
        },

        _thumbnail: function(doc) {
          if (doc.contextParameters.thumbnail.url) {
            return doc.contextParameters.thumbnail.url;
          } else {
            var baseUrl = this.$.nxcon.url;
            return baseUrl + '/nxthumb/default/' + doc.uid + '/blobholder:0/';
          }
        },

        ready: function() {
          // tmp fix
          // see https://github.com/PolymerElements/iron-list/issues/236
          this.$.itemsList._didMoveDown = function() {
            this._focusPhysicalItem(this._focusedIndex + 1);
          };
          // end tmp fix

          this.$.itemsList.selectQueuePrevious = function() {
            this._didMoveUp();
            this.toggleSelectionForFocusedItem();
          };
          this.$.itemsList.selectQueueNext = function() {
            this._didMoveDown();
            this.toggleSelectionForFocusedItem();
          };
          this.$.itemsList.toggleSelectionForFocusedItem = function() {
            this.debounce('toggleSelectionForFocusedItem', function() {
              var model = this._focusedItem._templateInstance;
              if (model) {
                this.toggleSelectionForItem(model[this.as]);
              }
            }.bind(this), 300);
          };
          this.$.itemsList.addOwnKeyBinding('up', 'toggleSelectionForFocusedItem');
          this.$.itemsList.addOwnKeyBinding('k', 'selectQueuePrevious');
          this.$.itemsList.addOwnKeyBinding('down', 'toggleSelectionForFocusedItem');
          this.$.itemsList.addOwnKeyBinding('j', 'selectQueueNext');

          // dinamically insert search form
          this._updateLayout();
        },

        _paramsChanged: function() {
          this.dirty = true;
          if (this._form) {
            this._form.params = this.params;
          }
        },

        _selectedSearchIdxChanged: function() {
          if (this._isSavedSearch()) {
            this.isSavedSearch = true;
            this.selectedSearch = this.searches[this.selectedSearchIdx - 1];
            this.params = this._mutateParams(this.selectedSearch.params);
          } else {
            this.isSavedSearch = false;
            this.selectedSearch = {};
            this._clear();
          }
          this.dirty = false;
        },

        _selectedSearchChanged: function() {
          this.params = this._mutateParams(this.selectedSearch.params);
          if (this.params && this.params.ecm_fulltext) {
            this.searchTerm = this.params.ecm_fulltext.replace('*', '');
            this._form.searchTerm = this.searchTerm;
          }
        },

        _isSavedSearch: function() {
          return this.selectedSearchIdx > 0;
        },

        _clear: function() {
          this.searchTerm = '';
          if (this._form) {
            this._form.searchTerm = '';
          }
          this.params = {};
          if (!this._isSavedSearch()) {
            this.dirty = false;
          }
          this.selectedSearchIdx = 0;
        },

        _reset: function() {
          var _el = this.$['saved-search'];
          _el.searchId = this.selectedSearch.id;
          _el.get().then(function(response) {
            this.params = this._mutateParams(response.params);
            this.searchTerm = this.params.ecm_fulltext ? this.params.ecm_fulltext.replace('*', '') : '';
            this._form.searchTerm = this.searchTerm;
            this.dirty = false;
          }.bind(this));
        },

        saveAs: function() {
          this.$.actionsDropdown.close();
          this.$.savedSearchTitle.value = '';
          this.$.saveDialog.open();
          this._saveAs = true;
        },

        save: function() {
          if (this.selectedSearchIdx === 0) {
            this.saveAs();
          } else {
            this._saveSearch();
          }
        },

        rename: function() {
          this._renaming = true;
          this.$.actionsDropdown.close();
          this.$.renameDialog.open();
          this.$.savedSearchRenameTitle.value = this.selectedSearch.title;
        },

        share: function() {
          this.$.actionsDropdown.close();
          this.$.shareDialog.open();
        },

        _saveSearch: function() {
          var _el = this.$['saved-search'];
          // save a new search
          if (this.selectedSearchIdx === 0 || this._saveAs) {
            _el.searchId = '';
            _el.data = {
              'entity-type': 'savedSearch',
              'pageProviderName': this.provider,
              'params': this.params,
              'title': this.$$('#savedSearchTitle').value
            };
            _el.post().then(function(response) {
              this.$.saveDialog.close();
              this.selectedSearch = response;
              this.$['saved-searches'].get().then(function() {
                this.selectedSearchIdx = this.searches.length;
              }.bind(this));
            }.bind(this));
          } else {
            // update an existing search
            _el.searchId = this.selectedSearch.id;
            _el.data = this.selectedSearch;
            if (this._renaming) {
              _el.data.title = this.$.savedSearchRenameTitle.value;
              _el.data.params = this._mutateParams(_el.data.params);
            } else {
              _el.data.params = this.params;
            }
            _el.put().then(function() {
              if (this._renaming) {
                this.$.renameDialog.close();

                this.set('searches.' + (this.selectedSearchIdx - 1) + '.title', _el.data.title);
                // hack required to update the paper-input inside the paper-dropdown-menu
                var idx = this.selectedSearchIdx;
                this.selectedSearchIdx = 0;
                this.selectedSearchIdx = idx;
                this._renaming = false;
              }
              this.dirty = false;
            }.bind(this));
          }
          this._saveAs = false;
        },

        _mutateParams: function(params) {
          return this.paramMutator ? this.paramMutator(params) : params;
        },

        _computeSavedSearchesParams: function() {
          return {pageProvider: this.provider};
        },

        _aggregationsChanged: function() {
          if (this._form) {
            this._form.aggregations = this.aggregations;
          }
        },

        /**
         * Retrieves and creates the search form for the current search type
         */
        _updateLayout: function() {
          var layout = ['nuxeo', this.searchName, 'search'].join('-');
          var url = this.resolveUrl(layout + '.html');
          this.importHref(url, this._createLayout.bind(this),
            // error handling
            function() {
              console.error('Failed to find search layout for ' + this.searchName);
            });
        },

        /**
         * Creates the layout for the current search type
         */
        _createLayout: function() {
          var layout = ['nuxeo', this.searchName, 'search'].join('-'),
              el = document.createElement(layout),
              parent = this.$['search-form-container'];
          parent.appendChild(el);
          el.id = 'search-form';
          this._form = el;
          this._form.aggregations = this.aggregations;
          // setup data binding
          el.addEventListener('params-changed', function(e) {
            // e.detail.path is params.prop_name eg: params.ecm_fulltext
            if (e.detail.path) {
              var param = e.detail.path.split('.')[1];
              this.set('params.' + param, e.detail.value);
            }
          }.bind(this));
        }
      });
    })();
  </script>
</dom-module>
