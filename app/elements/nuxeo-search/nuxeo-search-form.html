<!--
(C) Copyright 2015 Nuxeo SA (http://nuxeo.com/) and contributors.

All rights reserved. This program and the accompanying materials
are made available under the terms of the GNU Lesser General Public License
(LGPL) version 2.1 which accompanies this distribution, and is available at
http://www.gnu.org/licenses/lgpl.html

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
Lesser General Public License for more details.

Contributors:
    Andre Justo <ajusto@nuxeo.com>
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<!--
 `nuxeo-search-form`
 @group Nuxeo UI
 @element nuxeo-search-form
 -->
<dom-module id="nuxeo-search-form">
  <template>
    <style is="custom-style" include="shared-styles">
    :host {
      @apply(--layout-vertical);
      @apply(--layout-flex);
      display: block;
    }
    #scrollTheshold {
      /* scrollTheshold has to have
         an explicit height else infinite
         scrolling breaks */
      height: calc(100vh - 61px);
    }
    .list-item {
      cursor: pointer;
      padding: 1em;
      border-bottom: 1px solid #DDD;
    }
    .list-item:focus,
    .list-item.selected:focus {
      outline: 0;
      background-color: #ddd;
    }
    .list-item.selected {
      color: var(--paper-blue-600);
    }
    .list-item.selected {
      background-color: var(--google-grey-300);
      border-bottom: 1px solid #ccc;
    }
    .list-item-title {
      margin-left: 8px;
    }

    .list-item-detail {
      margin-left: 40px;
    }

    .list-item-property {
      color: var(--nuxeo-text-light);
      margin-right: .2em;
    }
    .manualLoading {
      color: var(--nuxeo-link-color);
      text-align: center;
    }

    .manualLoading:hover {
      cursor: pointer;
      color: var(--nuxeo-link-hover-color);
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
    }

    .filters {
      padding: 1em;
      height: calc(100vh - 61px);
      overflow: auto;
    }

    .switch {
      position: absolute;
      top: 0;
      right: 0;
      width: 60px;
      height: 60px;
      padding: 16px;
      z-index: 101;
      border: var(--nuxeo-border);
      background-color: var(--nuxeo-light-background);
    }

    .switch:hover {
        background-color: var(--nuxeo-button-primary);
        color: var(--nuxeo-button-primary-text);
      }

    /* TODO for Lise,need to factorize the following with nuxeo-app styles*/
    .content {
      font-size: .9rem;
      @apply(--layout-flex);
      @apply(--layout-vertical);
      height: calc(100vh - 61px);
      width: 290px;
    }

    .header {
      height: 59px;
      background-color: var(--nuxeo-light-background);
      border-bottom: var(--nuxeo-border);
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }

    .header h1 {
      color: var(--nuxeo-tag-text);
      text-transform: uppercase;
      font-size: 1rem;
      margin: .1em .2em 0 1.1em;
      font-weight: 500;
    }
    /* End TODO Lise :) */

    </style>

    <nuxeo-connection id="nxcon"></nuxeo-connection>
    <nuxeo-page-provider id="provider" auto
       provider="[[provider]]"
       aggregations="{{aggregations}}"
       enrichers="thumbnail"
       current-page="{{currentPage}}"
       is-next-page-available="{{isNextPageAvailable}}"
       current-page-size="{{currentPageSize}}"
       params="[[params]]"
       on-update="_updateSearchResults">
    </nuxeo-page-provider>

    <div class="header ellipsis search-header">
      <template is="dom-if" if="[[_isQueue]]">
        <h1>[[i18n('search_queue', 'Search Queue')]]</h1>
        <paper-icon-button class="switch" icon="editor:border-color" id="toogleFilter" on-tap="displayFilters">
        </paper-icon-button>
        <paper-tooltip for="toogleFilter">[[i18n('display_filter', 'Switch to filter view')]]</paper-tooltip>
      </template>
      <template is="dom-if" if="[[!_isQueue]]">
        <h1>[[i18n('search_filters', 'Search Filters')]]</h1>
        <paper-icon-button class="switch" icon="icons:list" id="toogleQueue" on-tap="displayQueue">
        </paper-icon-button>
        <paper-tooltip for="toogleQueue">[[i18n('display_queue', 'Switch to queue view')]]</paper-tooltip>
      </template>
    </div>

    <div class="content">

      <div id="filters" class="filters" hidden$="{{_isQueue}}">
        <iron-pages selected="[[selectedSearch]]" attr-for-selected="name">
          <!-- faceted search page -->
          <div name="faceted">
            <nuxeo-faceted-search aggregations="[[aggregations]]" params="{{params}}"></nuxeo-faceted-search>
          </div>

        </iron-pages>
      </div>

      <div id="queue" hidden$="{{!_isQueue}}">
        <iron-scroll-threshold id="scrollTheshold"
          lower-threshold="800" hidden$="[[!hasResults]]"
          on-lower-threshold="_loadMoreData">
          <iron-list id="itemsList" items="[[docItems]]" selected-item="{{selectedDocument}}" selection-enabled scroll-target="scrollTheshold">
            <template>
              <div tabindex$="{{tabIndex}}" class$="[[_computedClass(selected)]]">
                <div class="list-item-box vertical layout">
                  <div class="list-item-info horizontal layout center">
                    <div class="vertical layout center">
                      <img class="queue-thumbnail" src="[[_thumbnail(item)]]">
                    </div>
                    <span class="list-item-title ellipsis">[[item.title]]</span>
                  </div>
                  <div class="list-item-detail">
                    <div class="layout center">
                      <span class="list-item-property ellipsis">
                        [[item.type]]
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </iron-list>
          <template is="dom-if" if="[[showMore]]">
            <div class="item loading">
              <div class="primary">
                <paper-spinner class="nxicon" active="true"></paper-spinner>
                [[i18n('loading_more', 'Loading more data')]]
              </div>
              <div class="secondary dim">[[item.type]]</div>
            </div>
          </template>
        </iron-scroll-threshold>
        <div hidden$="[[hasResults]]" class="noResult">
          <span class="empty">[[i18n('no_results_found', 'No results found')]]</span>
        </div>
      </div>

    </div>

  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'nuxeo-search-form',

        properties: {

          selectedSearch: {
            type: String,
            value: 'faceted'
          },

          provider: {
            type: String,
            value: 'default_search'
          },
          currentIndex: {
            type: Number,
            notify: true
          },
          _isQueue: {
            type: Boolean,
            value: false
          },
          docItems: {
            type: Array,
            value: []
          },
          showMore: {
            type: Object,
            value: false
          },
          selectedDocument: {
            type: Object,
            observer: '_selectedDocChanged',
            notify: true
          },
          hasResults: {
            type: Boolean,
            value: true
          }
        },

        observers: [
          '_resetResults(provider, params.*)'
        ],

        _updateSearchResults: function() {
          var docs = this.$.provider.currentPage;
          docs.forEach(function(doc) {
            this.push('docItems', doc);
          }.bind(this));
          this.$.itemsList.fire('iron-resize');
          this.hasResults = !(this.docItems && this.docItems.length === 0);
          this.showMore = this.$.provider.isNextPageAvailable;
          this.$.scrollTheshold.clearTriggers();
          this.fire('initSearchResults', {
            provider: this.$.provider,
          });
        },

        _resetResults: function() {
          this.$.provider.page = 1;
          this.$.provider.pageSize = 40;
          this.docItems = [];
          this.selectedDocument = null;
          this.displayFilters();
          this.$.itemsList.fire('iron-resize');
          this.showMore = false;
          this.$.scrollTheshold.clearTriggers();
          this.fire('resetSearchResults');
        },

        displayQueue: function(doc, index) {
          this._isQueue = true;
          if (doc && doc.uid) {
            this.$.itemsList.selectItem(doc);
            this.$.itemsList.scrollToIndex(Math.max(0, index - 5));
          }
        },

        displayFilters: function() {
          this._isQueue = false;
        },

        _loadMoreData: function() {
          if (this.$.provider) {
            if (this.$.provider.isNextPageAvailable) {
              this.$.provider.page = this.$.provider.page + 1;
            }
          }
        },

        _computedClass: function(isSelected) {
          var classes = 'list-item';
          if (isSelected) {
            classes += ' selected';
          }
          return classes;
        },

        _selectedDocChanged: function(doc) {
          if (doc) {
            page.show('/browse' + doc.path);
          }
        },

        _thumbnail: function(doc) {
          if (doc.contextParameters.thumbnail.url) {
            return doc.contextParameters.thumbnail.url;
          } else {
            var baseUrl = this.$.nxcon.url;
            return baseUrl + '/nxthumb/default/' + doc.uid + '/blobholder:0/';
          }
        },

        ready: function() {
          // tmp fix
          // see https://github.com/PolymerElements/iron-list/issues/236
          this.$.itemsList._didMoveDown = function(e) {
            this._focusPhysicalItem(this._focusedIndex + 1);
          };
          // end tmp fix

          this.$.itemsList.selectQueuePrevious = function() {
            this._didMoveUp();
            this.toggleSelectionForFocusedItem();
          };
          this.$.itemsList.selectQueueNext = function() {
            this._didMoveDown();
            this.toggleSelectionForFocusedItem();
          };
          this.$.itemsList.toggleSelectionForFocusedItem = function() {
            this.debounce('toggleSelectionForFocusedItem', function() {
              var model = this._focusedItem._templateInstance;
              if (model) {
                this.toggleSelectionForItem(model[this.as]);
              }
            }.bind(this), 300);
          };
          this.$.itemsList.addOwnKeyBinding('up', 'toggleSelectionForFocusedItem');
          this.$.itemsList.addOwnKeyBinding('k', 'selectQueuePrevious');
          this.$.itemsList.addOwnKeyBinding('down', 'toggleSelectionForFocusedItem');
          this.$.itemsList.addOwnKeyBinding('j', 'selectQueueNext');
        }

      });
    })();
  </script>
</dom-module>
